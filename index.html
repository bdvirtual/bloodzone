<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BloodZone - Find a Donor</title>
    <meta name="description" content="BloodZone - Connect with blood donors to save lives.">
    <meta name="keywords" content="blood donation, blood bank, find donors">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23DC2626' d='M50 5 C25 20 25 50 50 95 C75 50 75 20 50 5 Z'/%3E%3Cpath fill='%234CAF50' d='M45 35 H55 V25 H45 V35 M35 45 H45 V55 H35 V45 M55 45 H65 V55 H55 V45 M45 55 H55 V65 H45 V55'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .heartbeat-bg {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M0 50 L20 50 L25 40 L35 60 L45 30 L55 70 L65 45 L75 55 L80 50 L100 50' fill='none' stroke='rgba(255,255,255,0.2)' stroke-width='3'/%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-position: center;
            animation: heartbeat 8s linear infinite;
        }
        @keyframes heartbeat {
            0% { background-position-x: 0; }
            100% { background-position-x: -200px; }
        }
        .modal-backdrop, .mobile-menu-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content, #mobile-menu {
            transition: transform 0.3s ease-in-out;
        }
        .nav-link.active {
            color: #DC2626;
            border-bottom: 2px solid #DC2626;
            padding-bottom: 0.25rem;
        }
        .mobile-nav-link.active {
            background-color: #FEE2E2;
            color: #DC2626;
        }
        .blood-cell-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            color: #DC2626;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .blood-cell-btn:hover {
            background-color: white;
            transform: scale(1.05);
        }
        .blood-cell-btn.active {
            background-color: white;
            border-color: #DC2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
        }
        .pagination-btn {
            min-width: 40px;
            height: 40px;
            padding: 0 0.5rem;
        }
        .pagination-btn.active {
            background-color: #DC2626;
            color: white;
            border-color: #DC2626;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .team-avatar-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .team-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header Section -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="https://github.com/bdvirtual/bloodzone" target="_blank">
                    <img src="assets/logo.png" alt="BloodZone Logo" class="h-12 w-12 rounded-full object-cover">
                </a>
                <div>
                    <a href="https://github.com/bdvirtual/bloodzone" target="_blank" class="text-xl font-bold text-red-600 router-link">
                        BloodZone
                    </a>
                </div>
            </div>
            <nav id="main-nav" class="hidden md:flex space-x-8">
                <a href="#find-donors" class="nav-link text-gray-700 hover:text-red-600 font-medium router-link active">Find Donors</a>
                <a href="#why-donate" class="nav-link text-gray-500 hover:text-red-600 font-medium router-link">Why Donate?</a>
                <a href="#about-us" class="nav-link text-gray-500 hover:text-red-600 font-medium router-link">About Us</a>
            </nav>
            <div class="hidden md:block">
                <a id="register-link-desktop" href="https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform" target="_blank" class="bg-red-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                    Register Now
                </a>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-btn" class="text-gray-600 hover:text-red-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu-container" class="fixed inset-0 z-40 pointer-events-none">
        <div id="mobile-menu-backdrop" class="mobile-menu-backdrop absolute inset-0 bg-black bg-opacity-50 opacity-0"></div>
        <div id="mobile-menu" class="absolute top-0 right-0 h-full w-64 bg-white shadow-xl p-6 transform translate-x-full">
            <nav class="flex flex-col space-y-4 mt-8">
                <a href="#find-donors" class="mobile-nav-link text-gray-700 hover:bg-gray-100 font-medium router-link p-3 rounded-lg">Find Donors</a>
                <a href="#why-donate" class="mobile-nav-link text-gray-700 hover:bg-gray-100 font-medium router-link p-3 rounded-lg">Why Donate?</a>
                <a href="#about-us" class="mobile-nav-link text-gray-700 hover:bg-gray-100 font-medium router-link p-3 rounded-lg">About Us</a>
            </nav>
            <a id="register-link-mobile" href="https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform" target="_blank" class="mt-8 w-full block text-center bg-red-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-red-700 transition duration-300">
                Register Now
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content"></div>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-6 text-center text-sm">
            <p>Developed by <a href="https://github.com/bdvirtual" target="_blank" class="underline hover:text-red-300">bdvirtual</a></p>
            <p class="mt-2">&copy; <span id="year"></span> BloodZone. Saving lives, one drop at a time.</p>
        </div>
    </footer>

    <!-- Contact Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 text-center modal-content transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Contact Information</h2>
            <p class="text-gray-500 mb-6">For donor privacy, direct contact is managed by BloodZone.</p>
            <div id="contact-details" class="text-left bg-gray-50 p-4 rounded-lg space-y-2"></div>
            <button id="close-contact-btn" class="mt-6 w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700">Close</button>
        </div>
    </div>

    <!-- Page Templates -->
    <template id="find-donors-template">
        <div id="find-donors-page" class="page">
            <section class="bg-red-600 text-white py-16 md:py-24 heartbeat-bg">
                <div class="container mx-auto px-6 text-center">
                    <h1 class="text-4xl md:text-5xl font-bold mb-4">Find a Lifesaver Near You</h1>
                    <blockquote class="text-lg text-red-100 italic mb-8 max-w-3xl mx-auto">
                        "And whoever saves one â€“ it is as if he had saved mankind entirely." (5:32)
                    </blockquote>
                    <div id="blood-group-stats" class="mb-8 grid grid-cols-4 sm:grid-cols-4 md:grid-cols-8 gap-2 max-w-2xl mx-auto text-center"></div>
                    <div class="bg-white/10 backdrop-blur-sm p-6 rounded-xl max-w-6xl mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 flex flex-col gap-6">
                                <div class="text-left">
                                    <label class="block text-sm font-medium text-red-100 mb-3 text-center md:text-left">Select Blood Group</label>
                                    <div id="blood-group-buttons" class="flex flex-wrap gap-3 justify-center md:justify-start">
                                        <button type="button" data-group="" class="blood-cell-btn active">All</button>
                                        <button type="button" data-group="A+" class="blood-cell-btn">A+</button>
                                        <button type="button" data-group="A-" class="blood-cell-btn">A-</button>
                                        <button type="button" data-group="B+" class="blood-cell-btn">B+</button>
                                        <button type="button" data-group="B-" class="blood-cell-btn">B-</button>
                                        <button type="button" data-group="AB+" class="blood-cell-btn">AB+</button>
                                        <button type="button" data-group="AB-" class="blood-cell-btn">AB-</button>
                                        <button type="button" data-group="O+" class="blood-cell-btn">O+</button>
                                        <button type="button" data-group="O-" class="blood-cell-btn">O-</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                    <div class="text-left">
                                        <label for="status-filter" class="block text-sm font-medium text-red-100 mb-2">Availability</label>
                                        <select id="status-filter" class="w-full p-3 rounded-lg bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-red-300">
                                            <option value="">Any</option>
                                            <option value="Available">Available Now</option>
                                            <option value="Unavailable">Unavailable</option>
                                        </select>
                                    </div>
                                    <button id="search-btn" class="w-full bg-white text-red-600 font-bold p-3 rounded-lg hover:bg-red-100 transition duration-300 text-lg">Search</button>
                                </div>
                            </div>
                            <div class="bg-white/20 rounded-xl p-6 flex flex-col justify-center items-center text-center gap-4">
                                <div>
                                    <p class="text-sm font-medium text-red-100">Matching Donors</p>
                                    <p id="filtered-donors-card" class="text-5xl font-bold">0</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-red-100">Total Donors</p>
                                    <p id="total-donors-card" class="text-3xl font-semibold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <main class="py-16">
                <div class="container mx-auto px-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Search Results</h2>
                    <div id="loading-indicator" class="text-center py-16"><p class="text-xl text-gray-500">Loading donors...</p></div>
                    <div id="donor-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 hidden"></div>
                    <div id="no-results" class="hidden text-center py-16"><p class="text-xl text-gray-500">No donors found matching your criteria.</p></div>
                    <div id="pagination-container" class="mt-12 flex justify-center items-center space-x-2"></div>
                </div>
            </main>
        </div>
    </template>
    <template id="why-donate-template">
        <div id="why-donate-page" class="page">
            <div class="container mx-auto px-6 py-16 text-gray-700">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Why Donate Blood?</h1>
                    <div class="space-y-6">
                        <div>
                            <h2 class="text-2xl font-semibold text-red-600 mb-3">Why Donate?</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Your donated blood can save a life, making a direct impact on someone in need.</li>
                                <li>Regular blood donation reduces the risk of heart disease and heart attacks.</li>
                                <li>Donating blood provides a free health checkup, screening for diseases like hepatitis, HIV, and more.</li>
                                <li>It boosts your immune system and overall health.</li>
                                <li>Blood donation is a rewarding act that brings a sense of fulfillment and community contribution.</li>
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold text-red-600 mb-3">Who Can Donate?</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Healthy individuals aged 18â€“60 years.</li>
                                <li>Minimum weight of 50 kg.</li>
                                <li>Free from major illnesses like hepatitis, HIV, or chronic diseases.</li>
                                <li>Not pregnant or menstruating (for women).</li>
                                <li>No recent surgeries or serious illnesses in the last 6 months.</li>
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold text-red-600 mb-3">Common Misconceptions</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Blood donation is painless; only a slight pinch is felt during needle insertion.</li>
                                <li>Donating blood does not weaken you; it can improve your health.</li>
                                <li>People with controlled diabetes or high blood pressure can donate if they meet health criteria.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="about-us-template">
        <div id="about-us-page" class="page">
            <div class="container mx-auto px-6 py-16">
                <div class="max-w-4xl mx-auto text-center">
                    <h1 class="text-4xl font-bold text-gray-800 mb-4">About BloodZone Team</h1>
                    <p class="text-gray-600 mb-12">We are a dedicated team at bdvirtual, committed to connecting donors with those in need to save lives through BloodZone.</p>
                    <h2 class="text-3xl font-bold text-gray-800 mb-8">Our Team</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
                        <div class="flex flex-col items-center">
                            <div class="team-avatar-container">
                                <img src="assets/team/member1.jpg" alt="Team Member 1" class="team-avatar">
                            </div>
                            <h3 class="text-xl font-bold mt-4 text-gray-800">Team Member 1</h3>
                            <a href="https://github.com/bdvirtual" target="_blank" class="text-red-600 hover:underline">View Profile</a>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="team-avatar-container">
                                <img src="assets/team/member2.jpg" alt="Team Member 2" class="team-avatar">
                            </div>
                            <h3 class="text-xl font-bold mt-4 text-gray-800">Team Member 2</h3>
                            <a href="https://github.com/bdvirtual" target="_blank" class="text-red-600 hover:underline">View Profile</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzcu53NZv5u9tcNfpiv2Cnh_EIm3AhToodEN9_IQvssuEYnL-VE6z9sufsXp5_o3Ij2hi2ou158C6F/pub?output=csv';
        let allDonors = [];
        let filteredDonors = [];
        let selectedBloodGroup = '';
        let currentPage = 1;
        const donorsPerPage = 8;

        const appContent = document.getElementById('app-content');
        const mainNav = document.getElementById('main-nav');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenuContainer = document.getElementById('mobile-menu-container');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
        const contactModal = document.getElementById('contact-modal');
        const closeContactBtn = document.getElementById('close-contact-btn');
        const contactDetails = document.getElementById('contact-details');

        function openModal(modal) {
            modal.classList.remove('pointer-events-none', 'opacity-0');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('pointer-events-none'), 300);
        }

        function toggleMobileMenu(show) {
            mobileMenuContainer.classList.toggle('pointer-events-none', !show);
            mobileMenuBackdrop.classList.toggle('opacity-0', !show);
            mobileMenu.classList.toggle('translate-x-full', !show);
        }

        function createDonorCard(donor) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 flex flex-col';
            card.innerHTML = `
                <div class="p-6 flex-grow">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="flex-shrink-0 w-16 h-16 bg-red-100 text-red-600 text-3xl font-bold rounded-full flex items-center justify-center">${donor.BloodGroup}</div>
                        <div><h3 class="text-lg font-bold text-gray-800">${donor.Name}</h3></div>
                    </div>
                    <div class="mt-4 space-y-3 text-sm">
                        <div class="flex justify-between"><span class="text-gray-500 font-medium">Gender:</span><span class="font-semibold text-gray-800 text-right">${donor.Gender}</span></div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4">
                    <button 
                        data-donor-name="${donor.Name}" 
                        data-donor-phone="${donor.Phone}"
                        data-donor-emergency-contact="${donor.EmergencyContact}"
                        data-donor-recent-surgery="${donor.RecentSurgery}"
                        data-donor-on-medication="${donor.OnMedication}"
                        class="contact-donor-btn w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700 transition duration-300">
                        Contact Donor
                    </button>
                </div>`;
            return card;
        }

        function renderDonors() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const donorGrid = document.getElementById('donor-grid');
            const noResultsEl = document.getElementById('no-results');
            const filteredCardEl = document.getElementById('filtered-donors-card');
            const totalCardEl = document.getElementById('total-donors-card');

            loadingIndicator.classList.add('hidden');
            donorGrid.innerHTML = '';
            filteredCardEl.textContent = filteredDonors.length;
            totalCardEl.textContent = allDonors.length;

            if (filteredDonors.length === 0) {
                noResultsEl.classList.remove('hidden');
                donorGrid.classList.add('hidden');
            } else {
                noResultsEl.classList.add('hidden');
                donorGrid.classList.remove('hidden');
                const startIndex = (currentPage - 1) * donorsPerPage;
                const endIndex = startIndex + donorsPerPage;
                const paginatedDonors = filteredDonors.slice(startIndex, endIndex);
                paginatedDonors.forEach(donor => donorGrid.appendChild(createDonorCard(donor)));
            }
            renderPagination();
        }

        function renderPagination() {
            const paginationContainer = document.getElementById('pagination-container');
            if (!paginationContainer) return;
            paginationContainer.innerHTML = '';
            const pageCount = Math.ceil(filteredDonors.length / donorsPerPage);
            if (pageCount <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.className = 'pagination-btn bg-white border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-100';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderDonors(); } });
            paginationContainer.appendChild(prevButton);

            for (let i = 1; i <= pageCount; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerText = i;
                pageButton.className = 'pagination-btn bg-white border border-gray-300 rounded-lg hover:bg-gray-100';
                if (i === currentPage) pageButton.classList.add('active');
                pageButton.addEventListener('click', () => { currentPage = i; renderDonors(); });
                paginationContainer.appendChild(pageButton);
            }

            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.className = 'pagination-btn bg-white border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-100';
            nextButton.disabled = currentPage === pageCount;
            nextButton.addEventListener('click', () => { if (currentPage < pageCount) { currentPage++; renderDonors(); } });
            paginationContainer.appendChild(nextButton);
        }

        function renderBloodGroupStats(stats) {
            const statsContainer = document.getElementById('blood-group-stats');
            if (!statsContainer) return;
            statsContainer.innerHTML = '';
            for (const group of ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-']) {
                const statEl = document.createElement('div');
                statEl.className = 'bg-white/20 p-2 rounded-lg';
                statEl.innerHTML = `<div class="text-xl font-bold">${stats[group] || 0}</div><div class="text-xs font-medium">${group}</div>`;
                statsContainer.appendChild(statEl);
            }
        }

        function filterDonors() {
            currentPage = 1;
            const statusFilter = document.getElementById('status-filter');
            const status = statusFilter ? statusFilter.value : '';
            filteredDonors = allDonors.filter(donor => {
                const bloodGroupMatch = !selectedBloodGroup || donor.BloodGroup === selectedBloodGroup;
                const statusMatch = !status || donor.Status === status;
                return bloodGroupMatch && statusMatch;
            });
            renderDonors();
        }

        function csvToJson(csv) {
            const lines = csv.split(/\r?\n/);
            const result = [];
            if (lines.length < 2) return result;
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const headerMapping = {
                'Full Name': 'Name',
                'Gender': 'Gender',
                'Blood Group': 'BloodGroup',
                'Phone Number': 'Phone',
                'Emergency Contact Name & Number': 'EmergencyContact',
                'Present Address (Area, Word, Thana, City/District)': 'Location',
                'Are you currently healthy and free from major illness?': 'HealthStatus',
                'Have you had any surgery or serious illness in the last 6 months?': 'RecentSurgery',
                'Are you currently taking any medication? (If yes, please mention)': 'OnMedication'
            };
            const requiredIndices = {};
            headers.forEach((header, index) => {
                const trimmedHeader = header.trim();
                for (const key in headerMapping) {
                    if (key.trim() === trimmedHeader) {
                        requiredIndices[headerMapping[key]] = index;
                    }
                }
            });
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i]) continue;
                const values = [];
                let current = '';
                let inQuotes = false;
                for (const char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current);
                if (values.length < headers.length) continue;
                const donor = {
                    Name: values[requiredIndices.Name]?.trim().replace(/"/g, ''),
                    Gender: values[requiredIndices.Gender]?.trim().replace(/"/g, ''),
                    BloodGroup: values[requiredIndices.BloodGroup]?.trim().replace(/"/g, ''),
                    Phone: values[requiredIndices.Phone]?.trim().replace(/"/g, ''),
                    EmergencyContact: values[requiredIndices.EmergencyContact]?.trim().replace(/"/g, ''),
                    Location: values[requiredIndices.Location]?.trim().replace(/"/g, ''),
                    Status: values[requiredIndices.HealthStatus]?.trim().replace(/"/g, '') === 'Yes' ? 'Available' : 'Unavailable',
                    RecentSurgery: values[requiredIndices.RecentSurgery]?.trim().replace(/"/g, ''),
                    OnMedication: values[requiredIndices.OnMedication]?.trim().replace(/"/g, '')
                };
                if (donor.Name) result.push(donor);
            }
            return result;
        }

        async function fetchDonors() {
            try {
                const response = await fetch(`${GOOGLE_SHEET_URL}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvData = await response.text();
                allDonors = csvToJson(csvData);
                const stats = allDonors.reduce((acc, donor) => {
                    if (donor.BloodGroup) acc[donor.BloodGroup] = (acc[donor.BloodGroup] || 0) + 1;
                    return acc;
                }, {});
                renderBloodGroupStats(stats);
                filterDonors();
            } catch (error) {
                console.error("Failed to fetch or parse donor data:", error);
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.innerHTML = `<p class="text-red-500">Failed to load donor data. Please check the URL and sheet format.</p>`;
            }
        }

        function handleRouteChange() {
            const hash = window.location.hash || '#find-donors';
            const pageId = hash.substring(1);
            const template = document.getElementById(`${pageId}-template`);
            appContent.innerHTML = '';
            if (template) {
                appContent.appendChild(template.content.cloneNode(true));
            } else {
                appContent.appendChild(document.getElementById('find-donors-template').content.cloneNode(true));
            }
            mainNav.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.getAttribute('href') === hash));
            mobileMenu.querySelectorAll('.mobile-nav-link').forEach(link => link.classList.toggle('active', link.getAttribute('href') === hash));
            if (pageId === 'find-donors') {
                fetchDonors();
                addFindDonorsListeners();
            }
            toggleMobileMenu(false);
        }

        function addFindDonorsListeners() {
            document.getElementById('search-btn').addEventListener('click', filterDonors);
            document.getElementById('status-filter').addEventListener('change', filterDonors);
            document.getElementById('blood-group-buttons').addEventListener('click', (e) => {
                if (e.target.matches('.blood-cell-btn')) {
                    document.querySelectorAll('.blood-cell-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedBloodGroup = e.target.dataset.group;
                    filterDonors();
                }
            });
            document.getElementById('donor-grid').addEventListener('click', (e) => {
                const contactBtn = e.target.closest('.contact-donor-btn');
                if (contactBtn) {
                    const medicalHistory = (contactBtn.dataset.donorRecentSurgery === 'Yes' || (contactBtn.dataset.donorOnMedication && contactBtn.dataset.donorOnMedication.toLowerCase() !== 'no')) ? 'Positive' : 'Negative';
                    contactDetails.innerHTML = `
                        <p><strong>Name:</strong> ${contactBtn.dataset.donorName}</p>
                        <p><strong>Phone:</strong> ${contactBtn.dataset.donorPhone}</p>
                        <p><strong>Emergency:</strong> ${contactBtn.dataset.donorEmergencyContact || 'N/A'}</p>
                        <p><strong>Medical History:</strong> ${medicalHistory}</p>
                    `;
                    openModal(contactModal);
                }
            });
        }

        mobileMenuBtn.addEventListener('click', () => toggleMobileMenu(true));
        mobileMenuBackdrop.addEventListener('click', () => toggleMobileMenu(false));
        closeContactBtn.addEventListener('click', () => closeModal(contactModal));
        window.addEventListener('hashchange', handleRouteChange);
        document.body.addEventListener('click', (e) => {
            if (e.target.matches('.router-link')) {
                e.preventDefault();
                window.location.hash = e.target.getAttribute('href');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('year').textContent = new Date().getFullYear();
            handleRouteChange();
        });
    </script>
</body>
</html>
